name: Daily OSINT Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'   # 07:00 Europe/Paris ≈ 06:00 UTC

jobs:
  daily-run:
    concurrency:
      group: osint-daily
      cancel-in-progress: false

    runs-on: ubuntu-latest
    env:
      TZ: Europe/Paris
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare environment variables (.env) and user session
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_TARGET_CHANNEL: ${{ secrets.TELEGRAM_TARGET_CHANNEL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TELEGRAM_USER_SESSION: ${{ secrets.TELEGRAM_USER_SESSION }}
          TELEGRAM_SOURCE_CHANNELS: ${{ secrets.TELEGRAM_SOURCE_CHANNELS }}
        shell: bash
        run: |
          mkdir -p data .secrets
          : > .env
          echo "TELEGRAM_API_ID=${TELEGRAM_API_ID}" >> .env
          echo "TELEGRAM_API_HASH=${TELEGRAM_API_HASH}" >> .env
          echo "TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}" >> .env
          echo "TELEGRAM_TARGET_CHANNEL=${TELEGRAM_TARGET_CHANNEL}" >> .env
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env
          # >>>> Remplace par tes handles valides si besoin
          echo "TELEGRAM_SOURCE_CHANNELS=${TELEGRAM_SOURCE_CHANNELS}" >> .env
          echo "OPENAI_MODEL=gpt-4o-mini" >> .env
          echo "OPENAI_EMBEDDINGS_MODEL=text-embedding-3-small" >> .env
          echo "FETCH_WINDOW_HOURS=24" >> .env
          echo "SQLITE_DB_PATH=data/osint.sqlite3" >> .env
          echo "TIMEZONE=Europe/Paris" >> .env
          echo "LOG_LEVEL=INFO" >> .env
          # Lecture en mode USER pour les étapes de collecte/traitement
          echo "TELEGRAM_MODE=user" >> .env
          # Session utilisateur (StringSession) disponible via env ET fichier
          echo "TELEGRAM_USER_SESSION=${TELEGRAM_USER_SESSION}" >> .env
          printf "%s" "${TELEGRAM_USER_SESSION}" > .secrets/telegram_session

      - name: Reset SQLite DB
        run: rm -f data/osint.sqlite3

      - name: Check config
        run: python -m src.main --check-config

      - name: Run OSINT pipeline (user mode)
        shell: bash
        timeout-minutes: 30
        run: |
          python -m src.main --fetch-recent --per-channel 100
          python -m src.main --translate --limit 150
          python -m src.main --embed --limit 200
          python -m src.main --summarize

      - name: Publish to Telegram (bot mode)
        shell: bash
        env:
          TELEGRAM_MODE: bot
        run: |
          python -m src.main --publish

      - name: Upload summary file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-summary
          path: exports/*.md
          if-no-files-found: ignore
          retention-days: 180

      - name: Notify Telegram on failure
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
        shell: bash
        run: |
          set -eu
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="OSINT pipeline FAILED | Repo=${{ github.repository }} | Branch=${GITHUB_REF_NAME} | Commit=${GITHUB_SHA} | Actor=${GITHUB_ACTOR} | Run=${RUN_URL}"
          curl -sS "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="${TEXT}" || echo "WARN: Telegram notification not sent"
